<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ–ö-–°–ú–ê–†–¢ | –í–æ–¥–∏—Ç–µ–ª—å AI</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f8f9fb;
            --card-bg: #ffffff;
            --text-main: #202124;
            --text-secondary: #70757a;
            --accent-color: #8e44ad;
            --accent-light: #f4ecf7;
            --price-green: #2ecc71;
            --border-color: #f0f0f0;
            --ai-color: #4285f4;
            --ai-light: #e8f0fe;
            --nav-blue: #007aff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Header */
        .app-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            background: white;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }

            .app-header .title {
                flex-grow: 1;
                text-align: center;
                font-weight: 600;
                font-size: 16px;
            }

        /* Route Cards */
        .route-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            position: relative;
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .route-number {
            font-size: 20px;
            font-weight: 700;
        }

        .route-stats {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .price-badge {
            background: #e8f9ef;
            color: var(--price-green);
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .section-label {
            font-size: 15px;
            font-weight: 700;
            margin: 12px 0 4px 0;
        }

        .address-text {
            font-size: 14px;
            color: var(--text-main);
            line-height: 1.4;
        }

        .sub-info {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Action Buttons */
        .btn-main {
            background: var(--accent-color);
            color: white;
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 18px;
            font-size: 16px;
            font-weight: 700;
            margin-top: 10px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

            .btn-main:active {
                opacity: 0.8;
            }

        .btn-ai {
            background: var(--ai-light);
            color: var(--ai-color);
            margin-bottom: 12px;
            font-size: 14px;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--nav-blue);
            color: var(--nav-blue);
            padding: 12px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 12px;
        }

        /* Basket View */
        .basket-item {
            display: flex;
            gap: 12px;
            padding: 16px 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            border-radius: 12px;
            transition: background 0.2s;
            margin: 0 -12px;
        }

            .basket-item:active {
                background-color: var(--accent-light);
            }

        .step-number {
            width: 24px;
            height: 24px;
            background: var(--accent-light);
            color: var(--accent-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .nav-icon {
            color: var(--accent-color);
            font-size: 18px;
            display: flex;
            align-items: center;
        }

        /* AI Suggestion Box */
        .ai-box {
            background: var(--ai-light);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
            font-size: 14px;
            color: var(--ai-color);
            line-height: 1.5;
            display: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: rotate 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes rotate {
            to {
                transform: rotate(360deg);
            }
        }

        /* Pages */
        .page {
            display: none;
        }

            .page.active {
                display: block;
            }

        .footer-action {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 16px;
            border-top: 1px solid var(--border-color);
            z-index: 1000;
        }

        .pb-large {
            padding-bottom: 140px;
        }
    </style>
</head>
<body>

    <div class="app-header">
        <div id="back-btn" style="cursor: pointer; font-size: 20px; display: none;" onclick="handleBack()">‚Äπ</div>
        <div class="title" id="page-title">–ì–æ—Ç–æ–≤—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã</div>
        <div style="width: 20px;"></div>
    </div>

    <!-- MAIN PAGE -->
    <div id="main-page" class="page active">
        <div class="container">
            <div id="routes-container"></div>
        </div>
    </div>

    <!-- BASKET PAGE -->
    <div id="basket-page" class="page">
        <div class="container pb-large">
            <div class="route-card">
                <button class="btn-main btn-ai" id="ai-opt-btn" onclick="optimizeWithAI()">
                    ‚ú® –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫ AI
                </button>

                <button class="btn-outline" onclick="buildFullRoute()">
                    üó∫ –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç —Ü–µ–ª–∏–∫–æ–º
                </button>

                <div class="section-label">–ü–æ–≥—Ä—É–∑–∫–∞</div>
                <div class="address-text" onclick="openMap('–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –ø–æ—Å—ë–ª–æ–∫ –®—É—à–∞—Ä—ã, –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ —à–æ—Å—Å–µ, 143')" style="cursor:pointer; color: var(--ai-color);">
                    üìç –®—É—à–∞—Ä—ã, –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ —à–æ—Å—Å–µ, 143
                </div>

                <div class="section-label" id="points-count-label">–†–∞–∑–≥—Ä—É–∑–∫–∞</div>
                <div id="basket-list"></div>

                <div id="ai-summary" class="ai-box"></div>
            </div>
        </div>
        <div class="footer-action">
            <button class="btn-main" onclick="takeToWork()">
                –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É
                <div style="font-size: 12px; font-weight: 400; margin-top: 2px;" id="route-summary-footer"></div>
            </button>
        </div>
    </div>

    <script>
        const apiKey = "AIzaSyCS4jxNh0dFe9InNgUxt_Xz2Ka6yZM2q4U";
        const tg = window.Telegram.WebApp;
        tg.expand();

        const routesData = [
            {
                id: 9782,
                distance: "444 –∫–º",
                time: "16 —á 25 –º",
                price: "12,400.00 ‚ÇΩ",
                loading: "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –ø–æ—Å—ë–ª–æ–∫ –®—É—à–∞—Ä—ã, –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ —à–æ—Å—Å–µ, 143",
                loadingBoxes: 34,
                points: [
                    { name: "–í—ã–±–æ—Ä–≥, –ü–æ–≥—Ä–∞–Ω–∏—á–Ω–∞—è —É–ª–∏—Ü–∞ 4", boxes: 3 },
                    { name: "–í—ã–±–æ—Ä–≥, –í–æ–∫–∑–∞–ª—å–Ω–∞—è —É–ª–∏—Ü–∞ 4", boxes: 1 },
                    { name: "–≥. –í—ã–±–æ—Ä–≥, —É–ª –†–æ—Å—Ç–æ–≤—Å–∫–∞—è —É–ª–∏—Ü–∞ –¥. 5", boxes: 2 },
                    { name: "–í—ã–±–æ—Ä–≥, —É–ª–∏—Ü–∞ –ú–∏—Ä–∞ 4", boxes: 4 },
                    { name: "–í—ã–±–æ—Ä–≥, –ü—Ä–æ—Å–ø–µ–∫—Ç –õ–µ–Ω–∏–Ω–∞ 18", boxes: 1 },
                    { name: "–í—ã–±–æ—Ä–≥, –ü—Ä–æ—Å–ø–µ–∫—Ç –°—É–≤–æ—Ä–æ–≤–∞ 7", boxes: 5 }
                ]
            },
            {
                id: 9785,
                distance: "90 –∫–º",
                time: "4 —á 1 –º",
                price: "3,800.00 ‚ÇΩ",
                loading: "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –ø–æ—Å—ë–ª–æ–∫ –®—É—à–∞—Ä—ã, –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ —à–æ—Å—Å–µ, 143",
                loadingBoxes: 22,
                points: [
                    { name: "–ì–∞—Ç—á–∏–Ω–∞, –ø—Ä–æ—Å–ø–µ–∫—Ç 25 –û–∫—Ç—è–±—Ä—è, 10", boxes: 12 },
                    { name: "–ì–∞—Ç—á–∏–Ω–∞, —É–ª. –°–æ–±–æ—Ä–Ω–∞—è, 5", boxes: 10 }
                ]
            }
        ];

        let currentRoute = null;
        let history = ['main-page'];

        // --- NAVIGATION HELPERS ---
        function openMap(address) {
            tg.HapticFeedback.impactOccurred('light');
            const url = `https://yandex.ru/maps/?text=${encodeURIComponent(address)}`;
            tg.openLink(url);
        }

        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º—É–ª—å—Ç–∏-–º–∞—Ä—à—Ä—É—Ç–∞ –≤ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∞—Ö
        function buildFullRoute() {
            if (!currentRoute) return;
            tg.HapticFeedback.impactOccurred('medium');

            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ç–æ—á–∫–∏: –ø–µ—Ä–≤–∞—è - —Å–∫–ª–∞–¥, –¥–∞–ª–µ–µ –≤—Å–µ –ü–í–ó
            const allAddresses = [currentRoute.loading, ...currentRoute.points.map(p => p.name)];

            // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç (—Ä–µ–∂–∏–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞)
            // –§–æ—Ä–º–∞—Ç: https://yandex.ru/maps/?mode=routes&rtext=A~B~C
            const routeString = allAddresses.map(addr => encodeURIComponent(addr)).join('~');
            const url = `https://yandex.ru/maps/?mode=routes&rtext=${routeString}`;

            tg.openLink(url);
        }

        // --- GEMINI API HELPERS ---
        async function callGemini(prompt, isJson = false) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "You are a professional logistics assistant. Analyze addresses and return optimized sequence." }] }
            };

            if (isJson) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            optimizedIndices: { type: "ARRAY", items: { type: "NUMBER" } },
                            aiAdvice: { type: "STRING" }
                        }
                    }
                };
            }

            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error("API call failed");
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) {
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
            throw new Error("Failed after retries");
        }

        async function optimizeWithAI() {
            const btn = document.getElementById('ai-opt-btn');
            const summaryBox = document.getElementById('ai-summary');
            const originalText = btn.innerText;

            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> ‚ú® –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∫–∞—Ä—Ç—É...';
            summaryBox.style.display = 'none';

            const prompt = `
                    –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π –ø–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –∫—É—Ä—å–µ—Ä–∞.
                    –ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ (—Å–∫–ª–∞–¥): ${currentRoute.loading}.
                    –¢–æ—á–∫–∏ —Ä–∞–∑–≥—Ä—É–∑–∫–∏: ${currentRoute.points.map((p, i) => `${i}: ${p.name}`).join('; ')}.
                    –í–µ—Ä–Ω–∏ –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è —Å–∞–º–æ–≥–æ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –ø—É—Ç–∏.
                `;

            try {
                const responseText = await callGemini(prompt, true);
                const data = JSON.parse(responseText);
                const newPoints = data.optimizedIndices.map(idx => currentRoute.points[idx]);
                currentRoute.points = newPoints;
                renderBasketList();
                summaryBox.innerText = "‚ú® AI –ü–æ–º–æ—â–Ω–∏–∫: –ú–∞—Ä—à—Ä—É—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –≤—Ä–µ–º–µ–Ω–∏. " + (data.aiAdvice || "");
                summaryBox.style.display = 'block';
                tg.HapticFeedback.notificationOccurred('success');
            } catch (err) {
                tg.showAlert("–û—à–∏–±–∫–∞ AI –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.");
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        // --- CORE APP LOGIC ---
        function init() {
            renderRoutes();
            tg.BackButton.onClick(handleBack);
        }

        function renderRoutes() {
            const container = document.getElementById('routes-container');
            container.innerHTML = '';
            routesData.forEach(route => {
                const card = document.createElement('div');
                card.className = 'route-card';
                card.innerHTML = `
                        <div class="route-header">
                            <div class="route-number">–ú–∞—Ä—à—Ä—É—Ç ${route.id}</div>
                            <div class="price-badge">${route.price}</div>
                        </div>
                        <div class="route-stats">${route.distance} ‚Ä¢ ${route.time}</div>
                        <div class="section-label">–ü–æ–≥—Ä—É–∑–∫–∞</div>
                        <div class="address-text">${route.loading}</div>
                        <div class="section-label">–†–∞–∑–≥—Ä—É–∑–∫–∞</div>
                        <div class="address-text">${route.points[0].name} ... (+${route.points.length - 1})</div>
                        <button class="btn-main" style="background: var(--accent-light); color: var(--accent-color); margin-top: 15px;" onclick="openBasket(${route.id})">
                            –î–µ—Ç–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞
                        </button>
                    `;
                container.appendChild(card);
            });
        }

        function openBasket(routeId) {
            currentRoute = JSON.parse(JSON.stringify(routesData.find(r => r.id === routeId)));
            document.getElementById('page-title').innerText = '–ú–∞—Ä—à—Ä—É—Ç ‚Ññ' + routeId;
            document.getElementById('route-summary-footer').innerText = `${currentRoute.time}; ${currentRoute.distance}; ${currentRoute.price}`;
            document.getElementById('ai-summary').style.display = 'none';
            renderBasketList();
            showPage('basket-page');
        }

        function renderBasketList() {
            document.getElementById('points-count-label').innerText = `–†–∞–∑–≥—Ä—É–∑–∫–∞ (${currentRoute.points.length} –ü–í–ó)`;
            const list = document.getElementById('basket-list');
            list.innerHTML = '';
            currentRoute.points.forEach((p, index) => {
                const item = document.createElement('div');
                item.className = 'basket-item';
                item.onclick = () => openMap(p.name);
                item.innerHTML = `
                        <div class="step-number">${index + 1}</div>
                        <div style="flex-grow: 1">
                            <div class="address-text">${p.name}</div>
                            <div class="sub-info">${p.boxes} —à—Ç</div>
                        </div>
                        <div class="nav-icon">üß≠</div>
                    `;
                list.appendChild(item);
            });
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (pageId === 'main-page') {
                tg.BackButton.hide();
                history = ['main-page'];
            } else {
                tg.BackButton.show();
                history.push(pageId);
            }
            window.scrollTo(0, 0);
        }

        function handleBack() { showPage('main-page'); }

        function takeToWork() {
            tg.showConfirm(`–í–∑—è—Ç—å –º–∞—Ä—à—Ä—É—Ç ‚Ññ${currentRoute.id} –≤ —Ä–∞–±–æ—Ç—É?`, (ok) => {
                if (ok) {
                    tg.HapticFeedback.impactOccurred('medium');
                    tg.showAlert("–ú–∞—Ä—à—Ä—É—Ç –ø—Ä–∏–Ω—è—Ç! –•–æ—Ä–æ—à–µ–π –¥–æ—Ä–æ–≥–∏.");
                    showPage('main-page');
                }
            });
        }

        init();
    </script>
</body>
</html>
